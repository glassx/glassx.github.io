<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">
  <link rel="alternate" href="/atom.xml" title="glassx的小黑屋" type="application/atom+xml">
  <meta http-equiv="Cache-Control" content="no-transform">
  <meta http-equiv="Cache-Control" content="no-siteapp">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">


<script id="hexo-configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '7.5.0',
    exturl: false,
    sidebar: {"position":"left","display":"post","offset":12,"onmobile":false},
    copycode: {"enable":false,"show_result":false,"style":null},
    back2top: {"enable":true,"sidebar":false,"scrollpercent":false},
    bookmark: {"enable":false,"color":"#222","save":"auto"},
    fancybox: false,
    mediumzoom: false,
    lazyload: false,
    pangu: false,
    algolia: {
      appID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    },
    localsearch: {"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":true},
    path: 'search.xml',
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    translation: {
      copy_button: '复制',
      copy_success: '复制成功',
      copy_failure: '复制失败'
    },
    sidebarPadding: 40
  };
</script>

  <meta name="description" content="生活是天籁，需要凝神静听">
<meta property="og:type" content="website">
<meta property="og:title" content="glassx的小黑屋">
<meta property="og:url" content="https://glassx.github.io/page/3/index.html">
<meta property="og:site_name" content="glassx的小黑屋">
<meta property="og:description" content="生活是天籁，需要凝神静听">
<meta property="og:locale" content="zh_CN">
<meta property="article:author" content="glassx">
<meta property="article:tag" content="glassx,码农">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="https://glassx.github.io/page/3/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome: true,
    isPost: false,
    isPage: false,
    isArchive: false
  };
</script>

  <title>glassx的小黑屋</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-meta">

    <div>
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">glassx的小黑屋</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
        <p class="site-subtitle">小黑屋</p>
  </div>

  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切换导航栏">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>
</div>


<nav class="site-nav">
  
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>首页</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>关于</a>

  </li>
        <li class="menu-item menu-item-tags">

    <a href="/tags/" rel="section"><i class="fa fa-fw fa-tags"></i>标签<span class="badge">39</span></a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-fw fa-th"></i>分类<span class="badge">12</span></a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>归档<span class="badge">223</span></a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜索
        </a>
      </li>
  </ul>

</nav>
  <div class="site-search">
    <div class="popup search-popup">
    <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input" id="search-input"></div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div class="algolia-results">
  <div id="algolia-stats"></div>
  <div id="algolia-hits"></div>
  <div id="algolia-pagination" class="algolia-pagination"></div>
</div>

  
</div>
<div class="search-pop-overlay"></div>

  </div>
</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>
  <div class="reading-progress-bar"></div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content">
            

  <div class="posts-expand">
        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://glassx.github.io/2023/06/26/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/02-%E7%BB%84%E4%BB%B6%E5%8C%96-%E7%AC%AC%E4%B8%89%E8%8A%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="glassx">
      <meta itemprop="description" content="生活是天籁，需要凝神静听">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glassx的小黑屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/26/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/02-%E7%BB%84%E4%BB%B6%E5%8C%96-%E7%AC%AC%E4%B8%89%E8%8A%82/" class="post-title-link" itemprop="url">02-组件化-第三节</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-26 09:42:00" itemprop="dateCreated datePublished" datetime="2023-06-26T09:42:00+08:00">2023-06-26</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-28 22:19:30" itemprop="dateModified" datetime="2023-06-28T22:19:30+08:00">2023-06-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">听课笔记</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="一、ARouter-中-Path-和-Group-的关系"><a href="#一、ARouter-中-Path-和-Group-的关系" class="headerlink" title="一、ARouter 中 Path 和 Group 的关系"></a>一、ARouter 中 Path 和 Group 的关系</h2><p>ARouter 里面这二者的关系比较简单，但是单纯看代码可能会比较蒙。其实很简单，用最简单的图示就能说清楚：</p>
<p><img src="/assets/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/%E4%BA%AB%E5%AD%A6Android%E7%AC%AC%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/Group%E4%B8%8EPath%E5%85%B3%E7%B3%BB.jpg" alt="Group和Path的关系"></p>
<ul>
<li><p>Group：每个 Module 作为一个 Group 组</p>
</li>
<li><p>Path：每个 Module 中所有的 Activity （还可以拓展 Fragment）都放在 Path 里面</p>
</li>
</ul>
<p>体现在代码里面就是生成的2种类（Group 和 Path）：</p>
<figure class="highlight plaintext"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">public class ARouter$$Group$$personal implements ARouterGroup {</span><br><span class="line">  @Overrideag-0-1h3qlcbapag-1-1h3qlcbap</span><br><span class="line">  public Map&lt;String, Class&lt;? extends ARouterPath&gt;&gt; getGroupMap() {</span><br><span class="line">    Map&lt;String, Class&lt;? extends ARouterPath&gt;&gt; groupMap = new HashMap&lt;&gt;();</span><br><span class="line">    groupMap.put("personal", ARouter$$Path$$personal.class);</span><br><span class="line">    return groupMap;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouter</span>$$<span class="title">Path</span>$$<span class="title">personal</span> <span class="keyword">implements</span> <span class="title">ARouterPath</span> </span>{</span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="function"><span class="keyword">public</span> Map&lt;String, RouterBean&gt; <span class="title">getPathMap</span><span class="params">()</span> </span>{</span><br><span class="line">    Map&lt;String, RouterBean&gt; pathMap = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line">    pathMap.put(<span class="string">"/personal/Personal_Main2Activity"</span>, RouterBean.create();</span><br><span class="line">    pathMap.put(<span class="string">"/personal/Personal_MainActivity"</span>, RouterBean.create());</span><br><span class="line">    <span class="keyword">return</span> pathMap;</span><br><span class="line">  }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>可以看到，在Group 类中 Map 是添加了 Path 的： </p>
<blockquote>
<p>groupMap.put(“personal”, ARouter$$Path$$personal.class);</p>
</blockquote>
<p>然后Path 里面的 pathMap 存放的key 是 path （如：”/personal/Personal_MainActivity”），value 是 Mainactivity.class （只不过被封装成 RouterBean 了）。</p>
<blockquote>
<p>思考下，Path 类和 Group 类哪个先生成？肯定是 Path ，因为 Group 需要依赖 Path </p>
</blockquote>
<p>使用JavaPoet 的时候，生成类型的时候，可以用 $T 来代替这个类型，再后面写上类型，类似于Android 中的 %1$s 的写法，比如构建 Map&lt;String, Class&lt;? extends ARouterPath&gt;&gt; groupMap = new HashMap&lt;&gt;(); 这行代码的时候：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">methodBuidler.addStatement(<span class="string">"$T&lt;$T, $T&gt; $N = new $T&lt;&gt;()"</span>,</span><br><span class="line">        ClassName.get(Map.class),</span><br><span class="line">        ClassName.get(String.class),</span><br><span class="line"></span><br><span class="line">        <span class="comment">// Class&lt;? extends ARouterPath&gt; 难度</span></span><br><span class="line">        ParameterizedTypeName.get(ClassName.get(Class.class),</span><br><span class="line">                WildcardTypeName.subtypeOf(ClassName.get(pathType))), <span class="comment">// ? extends ARouterPath</span></span><br><span class="line">                ProcessorConfig.GROUP_VAR1,</span><br><span class="line">                ClassName.get(HashMap.class));</span><br></pre></td></tr></tbody></table></figure>

<p>看了代码，感觉太复杂的情况还不如直接不使用 Javapoet ，使用字符串去做还好点。</p>
<p>在自动生成 Group 和 Path 相关的类之后，我们可以使用如下方式去实现页面跳转了：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jumpPersonal</span><span class="params">(View view)</span> </span>{</span><br><span class="line">    <span class="comment">// 以前是这样跳转</span></span><br><span class="line">    <span class="comment">/*Intent intent = new Intent(this, Personal_MainActivity.class);</span></span><br><span class="line"><span class="comment">    intent.putExtra("name", "derry");</span></span><br><span class="line"><span class="comment">    startActivity(intent);*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 现在是这样跳转  目前还要写这么多代码，是不是非常累</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// TODO 最终的成效：用户 一行代码搞定，同时还可以传递参数，同时还可以懒加载</span></span><br><span class="line"></span><br><span class="line">    ARouter$$Group$$personal group$$personal = <span class="keyword">new</span> ARouter$$Group$$personal();</span><br><span class="line">    Map&lt;String, Class&lt;? extends ARouterPath&gt;&gt; groupMap = group$$personal.getGroupMap();</span><br><span class="line">    Class&lt;? extends ARouterPath&gt; myClass = groupMap.get(<span class="string">"personal"</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        ARouter$$Path$$personal path = (ARouter$$Path$$personal) myClass.newInstance();</span><br><span class="line">        Map&lt;String, RouterBean&gt; pathMap = path.getPathMap();</span><br><span class="line">        RouterBean bean = pathMap.get(<span class="string">"/personal/Personal_MainActivity"</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (bean != <span class="keyword">null</span>) {</span><br><span class="line">            Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, bean.getMyClass());</span><br><span class="line">            startActivity(intent);</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">    } <span class="keyword">catch</span> (Exception e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>我们先 new 出特定的 Group 对象，再获取其 Map 对象（这是缓存仓库，存储了其所有的 Path），然后根据 path 的name 获取到 Path 类的 Class 文件，之后使用这个 class 文件就能 newInstance 得出 path 对象，从path 对象中再得到其 Map 对象，最后，根据路径，从这个 Map 对象获得 RouterBean （也就是目标Activity 的Class ）。</p>
<p>可见，到目前这一步还是很麻烦的，所以ARouter 再生成的代码上再一次生成代码，进一步封装。</p>
<p>注：</p>
<p>JavaPoet API：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/square/javapoet">https://github.com/square/javapoet</a></p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://glassx.github.io/2023/06/25/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/02-%E7%BB%84%E4%BB%B6%E5%8C%96-%E7%AC%AC%E4%BA%8C%E8%8A%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="glassx">
      <meta itemprop="description" content="生活是天籁，需要凝神静听">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glassx的小黑屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/25/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/02-%E7%BB%84%E4%BB%B6%E5%8C%96-%E7%AC%AC%E4%BA%8C%E8%8A%82/" class="post-title-link" itemprop="url">02-组件化-第二节</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-25 11:11:00" itemprop="dateCreated datePublished" datetime="2023-06-25T11:11:00+08:00">2023-06-25</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-28 22:17:20" itemprop="dateModified" datetime="2023-06-28T22:17:20+08:00">2023-06-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">听课笔记</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="一、前情回顾"><a href="#一、前情回顾" class="headerlink" title="一、前情回顾"></a>一、前情回顾</h2><p>早期的 XUtil 框架是使用<strong>运行期注解，采用的是反射</strong>，后续都比较倾向于编译器框架 APT 了，因为运行期反射还是有点消耗性能，目前采用编译期注解的框架有：Dagger2、Room、ARouter、Buterkife、DataBinding 等。</p>
<blockquote>
<p>如果想学 APT 的使用，怎么自己生成代码，可以去看EventBus 中的注解处理器</p>
</blockquote>
<h2 id="二、使用-JavaPoet"><a href="#二、使用-JavaPoet" class="headerlink" title="二、使用 JavaPoet"></a>二、使用 JavaPoet</h2><p>但是上述EventBus 那种生成代码的方式有点 Low ，需要一行一行地写，从 import 写到最后一行，手抖写错一个标点符号就崩了。因此，我们可以看 ARouter 的，它里面使用了 JavaPoet 框架。但是传统方式看起来更直观，JavaPoet 看起来比较难。</p>
<h3 id="2-1-如何去使用APT"><a href="#2-1-如何去使用APT" class="headerlink" title="2.1 如何去使用APT"></a>2.1 如何去使用APT</h3><p>新建 Android工程，在其中 new 一个 Lib 出来，用于存放所有的注解代码，再new 一个Lib ，作为注解处理器，项目结构如下所示：</p>
<p><img src="/assets/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/%E4%BA%AB%E5%AD%A6Android%E7%AC%AC%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/%E4%BD%BF%E7%94%A8APT.png" alt="APT使用时工程目录"></p>
<p>这样划分是为了能够隔离项目代码和 APT 代码。需要把compiler 变为一个服务，监听 项目中关注的注解，所以就需要google 的 autoservice 以及生成代码需要用 JavaPoet ，所以 compiler 这个 Module 的 build.gradle 的文件如下：</p>
<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">'java-library'</span></span><br><span class="line"></span><br><span class="line">dependencies {</span><br><span class="line">    implementation fileTree(<span class="attr">dir:</span> <span class="string">'libs'</span>, <span class="attr">include:</span> [<span class="string">'*.jar'</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 背后的服务 能够监听 你是否在编译中.....</span></span><br><span class="line">    <span class="comment">// AS3.4.1 + Gradle 5.1.1 + auto-service:1.0-rc4</span></span><br><span class="line">    compileOnly<span class="string">'com.google.auto.service:auto-service:1.0-rc4'</span></span><br><span class="line">    annotationProcessor<span class="string">'com.google.auto.service:auto-service:1.0-rc4'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 帮助我们通过类调用的形式来生成Java代码 [JavaPoet]</span></span><br><span class="line">    implementation <span class="string">"com.squareup:javapoet:1.9.0"</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 依赖注解</span></span><br><span class="line">    implementation project(<span class="string">":arouter-annotations"</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">sourceCompatibility = <span class="string">"1.7"</span></span><br><span class="line">targetCompatibility = <span class="string">"1.7"</span></span><br></pre></td></tr></tbody></table></figure>

<p>我们的项目也需要依赖我们的注解工程，所以需要在其 build.gradle 中添加注解和注解处理器的依赖，以及一些参数的传递，所以代码是这样的：</p>
<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">plugin:</span> <span class="string">'com.android.application'</span></span><br><span class="line"></span><br><span class="line">android {</span><br><span class="line">    compileSdkVersion <span class="number">30</span></span><br><span class="line">    buildToolsVersion <span class="string">"30.0.1"</span></span><br><span class="line"></span><br><span class="line">    defaultConfig {</span><br><span class="line">        applicationId <span class="string">"com.derry.new_modular_javapoet"</span></span><br><span class="line">        minSdkVersion <span class="number">16</span></span><br><span class="line">        targetSdkVersion <span class="number">30</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">"1.0"</span></span><br><span class="line"></span><br><span class="line">        testInstrumentationRunner <span class="string">"androidx.test.runner.AndroidJUnitRunner"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// 传递参数</span></span><br><span class="line">        javaCompileOptions {</span><br><span class="line">            annotationProcessorOptions {</span><br><span class="line">                arguments = [<span class="attr">student:</span> <span class="string">'hello ni hao student javapoet'</span>]</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    buildTypes {</span><br><span class="line">        release {</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android-optimize.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">dependencies {</span><br><span class="line">    implementation fileTree(<span class="attr">dir:</span> <span class="string">"libs"</span>, <span class="attr">include:</span> [<span class="string">"*.jar"</span>])</span><br><span class="line">    implementation <span class="string">'androidx.appcompat:appcompat:1.2.0'</span></span><br><span class="line">    implementation <span class="string">'androidx.constraintlayout:constraintlayout:2.0.4'</span></span><br><span class="line">    implementation project(<span class="attr">path:</span> <span class="string">':arouter-annotations'</span>)</span><br><span class="line">    implementation project(<span class="attr">path:</span> <span class="string">':arouter-annotations'</span>)</span><br><span class="line">    testImplementation <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    androidTestImplementation <span class="string">'androidx.test.ext:junit:1.1.2'</span></span><br><span class="line">    androidTestImplementation <span class="string">'androidx.test.espresso:espresso-core:3.3.0'</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 依赖注解</span></span><br><span class="line">    implementation project(<span class="string">":arouter-annotations"</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 依赖注解处理器 注解处理器才能工作</span></span><br><span class="line">    annotationProcessor project(<span class="string">":compiler"</span>)</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>接下来就是写compiler 这个 module 中的代码里，它是真正的处理器：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.derry.compiler;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.derry.arouter_annotations.ARouter;</span><br><span class="line"><span class="keyword">import</span> com.google.auto.service.AutoService;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.ClassName;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.JavaFile;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.MethodSpec;</span><br><span class="line"><span class="keyword">import</span> com.squareup.javapoet.TypeSpec;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.io.IOException;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Type;</span><br><span class="line"><span class="keyword">import</span> java.util.Set;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.AbstractProcessor;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.Filer;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.Messager;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.ProcessingEnvironment;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.Processor;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.RoundEnvironment;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.SupportedAnnotationTypes;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.SupportedOptions;</span><br><span class="line"><span class="keyword">import</span> javax.annotation.processing.SupportedSourceVersion;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.SourceVersion;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.Element;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.Modifier;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.element.TypeElement;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.util.Elements;</span><br><span class="line"><span class="keyword">import</span> javax.lang.model.util.Types;</span><br><span class="line"><span class="keyword">import</span> javax.tools.Diagnostic;</span><br><span class="line"></span><br><span class="line"><span class="meta">@AutoService(Processor.class)</span> <span class="comment">// 启用google提供的 autoservice 服务</span></span><br><span class="line"><span class="meta">@SupportedAnnotationTypes({"com.derry.arouter_annotations.ARouter"})</span> <span class="comment">// 你自己写的注解位置，包名+类名</span></span><br><span class="line"><span class="meta">@SupportedSourceVersion(SourceVersion.RELEASE_7)</span> <span class="comment">// 环境的版本</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 接收 安卓工程传递过来的参数</span></span><br><span class="line"><span class="meta">@SupportedOptions("student")</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ARouterProcessor</span> <span class="keyword">extends</span> <span class="title">AbstractProcessor</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 操作Element的工具类（类，函数，属性，其实都是Element）</span></span><br><span class="line">    <span class="keyword">private</span> Elements elementTool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// type(类信息)的工具类，包含用于操作TypeMirror的工具方法</span></span><br><span class="line">    <span class="keyword">private</span> Types typeTool;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Message用来打印 日志相关信息，在编译期间不能使用Android的Log工具</span></span><br><span class="line">    <span class="keyword">private</span> Messager messager;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 文件生成器， 类 资源 等，就是最终要生成的文件 是需要Filer来完成的，此时还不能使用Java的File</span></span><br><span class="line">    <span class="keyword">private</span> Filer filer;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(ProcessingEnvironment processingEnvironment)</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.init(processingEnvironment);</span><br><span class="line"></span><br><span class="line">        elementTool = processingEnvironment.getElementUtils();</span><br><span class="line">        messager = processingEnvironment.getMessager();</span><br><span class="line">        filer = processingEnvironment.getFiler();</span><br><span class="line"></span><br><span class="line">        String value = processingEnvironment.getOptions().get(<span class="string">"student"</span>);</span><br><span class="line">        <span class="comment">// 这个代码已经下毒了</span></span><br><span class="line">        <span class="comment">// 如果我想在注解处理器里面抛出异常 可以使用Diagnostic.Kind.ERROR</span></span><br><span class="line">        messager.printMessage(Diagnostic.Kind.NOTE, <span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span>+value);</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 服务：在编译的时候干活</span></span><br><span class="line">    <span class="comment">// 坑：如果没有在任何地方使用，次函数是不会工作的</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">process</span><span class="params">(Set&lt;? extends TypeElement&gt; set, RoundEnvironment roundEnvironment)</span> </span>{</span><br><span class="line">        <span class="comment">// 这个代码已经下毒了</span></span><br><span class="line">        messager.printMessage(Diagnostic.Kind.NOTE, <span class="string">"&gt;&gt;&gt;&gt;&gt;&gt;&gt; Derry run..."</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (set.isEmpty()) {</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">false</span>; <span class="comment">// 不干活</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 循环？</span></span><br><span class="line">        <span class="comment">// 获取被 ARouter注解的 "类节点信息"</span></span><br><span class="line">        Set&lt;? extends Element&gt; elements = roundEnvironment.getElementsAnnotatedWith(ARouter.class);</span><br><span class="line">        <span class="keyword">for</span> (Element element : elements) { <span class="comment">// for 3    // 1 element == MainActivity    2 element == MainActivity2</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             模块一</span></span><br><span class="line"><span class="comment">             package com.example.helloworld;</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             public final class HelloWorld {</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             public static void main(String[] args) {</span></span><br><span class="line"><span class="comment">                 System.out.println("Hello, JavaPoet!");</span></span><br><span class="line"><span class="comment">             }</span></span><br><span class="line"><span class="comment">             }</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="comment">// Java 万物皆对象</span></span><br><span class="line">            <span class="comment">// C  万物皆指针</span></span><br><span class="line">            <span class="comment">/*// 1.方法</span></span><br><span class="line"><span class="comment">            MethodSpec mainMethod = MethodSpec.methodBuilder("main")</span></span><br><span class="line"><span class="comment">                    .addModifiers(Modifier.PUBLIC, Modifier.STATIC)</span></span><br><span class="line"><span class="comment">                    .returns(void.class)</span></span><br><span class="line"><span class="comment">                    .addParameter(String[].class, "args")</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    // 增加main方法里面的内容</span></span><br><span class="line"><span class="comment">                    .addStatement("$T.out.println($S)", System.class, "Hello, JavaPoet!")</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                    .build();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            // 2.类</span></span><br><span class="line"><span class="comment">            TypeSpec testClass = TypeSpec.classBuilder("DerryTest")</span></span><br><span class="line"><span class="comment">                    .addMethod(mainMethod)</span></span><br><span class="line"><span class="comment">                    .addModifiers(Modifier.PUBLIC, Modifier.FINAL)</span></span><br><span class="line"><span class="comment">                    .build();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            // 3.包</span></span><br><span class="line"><span class="comment">            JavaFile packagef = JavaFile.builder("com.xiangxue.test", testClass).build();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">            // 生成文件</span></span><br><span class="line"><span class="comment">            try {</span></span><br><span class="line"><span class="comment">                packagef.writeTo(filer);</span></span><br><span class="line"><span class="comment">            } catch (IOException e) {</span></span><br><span class="line"><span class="comment">                e.printStackTrace();</span></span><br><span class="line"><span class="comment">                messager.printMessage(Diagnostic.Kind.NOTE, "生成Test文件时失败，异常:" + e.getMessage());</span></span><br><span class="line"><span class="comment">            }*/</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 包信息</span></span><br><span class="line">            String packageName = elementTool.getPackageOf(element).getQualifiedName().toString();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 获取简单类名，例如：MainActivity  MainActivity2  MainActivity3</span></span><br><span class="line">            String className = element.getSimpleName().toString();</span><br><span class="line">            messager.printMessage(Diagnostic.Kind.NOTE, <span class="string">"被@ARetuer注解的类有："</span> + className);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// String className = element.getSimpleName().toString();</span></span><br><span class="line"></span><br><span class="line">            <span class="comment">// 目标：要生成的文件名称  MainActivity$$$$$$$$$ARouter</span></span><br><span class="line">            String finalClassName = className + <span class="string">"$$$$$$$$$ARouter"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             模板：</span></span><br><span class="line"><span class="comment">             public class MainActivity3$$$$$$$$$ARouter {</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">                public static Class findTargetClass(String path) {</span></span><br><span class="line"><span class="comment">                    return path.equals("/app/MainActivity3") ? MainActivity3.class : null;</span></span><br><span class="line"><span class="comment">                }</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">             }</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line"></span><br><span class="line">            ARouter aRouter = element.getAnnotation(ARouter.class);</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 1.方法</span></span><br><span class="line">            MethodSpec findTargetClass = MethodSpec.methodBuilder(<span class="string">"findTargetClass"</span>)</span><br><span class="line">                    .addModifiers(Modifier.PUBLIC, Modifier.STATIC)</span><br><span class="line">                    .returns(Class.class)</span><br><span class="line">                    .addParameter(String.class, <span class="string">"path"</span>)</span><br><span class="line">                    <span class="comment">// 方法里面的内容 return path.equals("/app/MainActivity3") ? MainActivity3.class : null;</span></span><br><span class="line"></span><br><span class="line">                    <span class="comment">// 需要JavaPoet包装转型</span></span><br><span class="line">                    .addStatement(<span class="string">"return path.equals($S) ? $T.class : null"</span>,</span><br><span class="line">                            aRouter.path(),</span><br><span class="line">                            ClassName.get((TypeElement) element))</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 2.类</span></span><br><span class="line">            TypeSpec myClass = TypeSpec.classBuilder(finalClassName)</span><br><span class="line">                    .addMethod(findTargetClass)</span><br><span class="line">                    .addModifiers(Modifier.PUBLIC)</span><br><span class="line">                    .build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 3.包</span></span><br><span class="line">            JavaFile packagef = JavaFile.builder(packageName, myClass).build();</span><br><span class="line"></span><br><span class="line">            <span class="comment">// 开始生成</span></span><br><span class="line">            <span class="keyword">try</span> {</span><br><span class="line">                packagef.writeTo(filer);</span><br><span class="line">            } <span class="keyword">catch</span> (IOException e) {</span><br><span class="line">                e.printStackTrace();</span><br><span class="line">                messager.printMessage(Diagnostic.Kind.NOTE, <span class="string">"生成"</span> + finalClassName + <span class="string">"文件时失败，异常:"</span> + e.getMessage());</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">true</span>; <span class="comment">// false不干活了      true干完了</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在编译的时候，如果要从 Android 端传入参数到 APT 中来的话，怎么操作呢？因为这 2 者肯定是不能直接通信的，我们可以从 gradle 中来中转，在应用module 的 build.gradle 中采用 javaCompileOptions 来解决：</p>
<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 传递参数</span></span><br><span class="line">javaCompileOptions {</span><br><span class="line">    annotationProcessorOptions {</span><br><span class="line">        arguments = [<span class="attr">student:</span> <span class="string">'hello ni hao student javapoet'</span>]</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>在 APT 中接收这个参数，就在 APT 代码上面加上注解：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 接收 安卓工程传递过来的参数</span></span><br><span class="line"><span class="meta">@SupportedOptions("student")</span></span><br></pre></td></tr></tbody></table></figure>

<h2 id="三、JavaPoet高级用法"><a href="#三、JavaPoet高级用法" class="headerlink" title="三、JavaPoet高级用法"></a>三、JavaPoet高级用法</h2><p>最后，如果要在 Android 中使用这个注解处理器，还需要在 Android 工程中的 build.gradle 中依赖它，加上之前加入的依赖注解代码，就是这样的：</p>
<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 依赖注解</span></span><br><span class="line">implementation project(<span class="string">":arouter-annotations"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 依赖注解处理器 注解处理器才能工作</span></span><br><span class="line">annotationProcessor project(<span class="string">":compiler"</span>)</span><br></pre></td></tr></tbody></table></figure>

<p>所以，这个 annotationProcessor 声明 是要注意的。</p>
<p>javapoet 主要需要注意的是步骤：</p>
<ol>
<li><p>生成方法</p>
</li>
<li><p>生成类</p>
</li>
<li><p>生成包</p>
</li>
</ol>
<p>老师说这个可以去讲一下：EventBus 使用的是普通的写的方式，所以很困难，整个类就是一个字符串，写得非常难。但是 ARouter 使用 javapoet 使用就很简单。</p>
<h2 id="四、路由分组设计"><a href="#四、路由分组设计" class="headerlink" title="四、路由分组设计"></a>四、路由分组设计</h2><p>很多开源框架的注解设计是这种思想：</p>
<ul>
<li><p>在 compiler 这个 Module 中是正儿八经的注解处理器</p>
</li>
<li><p>在 xx_annotation 这个目录下写我们的注解（比如 ARouter 中这里就写 ARouter 这个注解类，并标明这个注解是修饰类，编译时注解）</p>
</li>
<li><p>xx_api 这个目录写的是注解相关的逻辑（用于与业务逻辑区分，比如 ARouter 中是ARouterGroup、ARouterPath 类，以及将 Activity 等放入相应的 Map 等逻辑）</p>
</li>
</ul>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://glassx.github.io/2023/06/23/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/02-%E7%BB%84%E4%BB%B6%E5%8C%96-%E7%AC%AC%E4%B8%80%E8%8A%82/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="glassx">
      <meta itemprop="description" content="生活是天籁，需要凝神静听">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glassx的小黑屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/23/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/02-%E7%BB%84%E4%BB%B6%E5%8C%96-%E7%AC%AC%E4%B8%80%E8%8A%82/" class="post-title-link" itemprop="url">02-组件化-第一节</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-23 15:41:00" itemprop="dateCreated datePublished" datetime="2023-06-23T15:41:00+08:00">2023-06-23</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-30 17:23:40" itemprop="dateModified" datetime="2023-06-30T17:23:40+08:00">2023-06-30</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">听课笔记</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="一、起因"><a href="#一、起因" class="headerlink" title="一、起因"></a>一、起因</h2><p>早期的时候，一个项目都在一个一起，通过包名来控制不同的模块和功能。这种方式的缺点：</p>
<ul>
<li>层次混乱：无论怎么做分包，随着项目增大，就会失去层次感，接手的人扑街</li>
<li>耦合度高，低内聚：。包名约束太弱，稍不注意就不同业务包直接相互调用</li>
<li>不易于版本管理，容易代码冲突</li>
<li>难以重用</li>
</ul>
<p>所以，很容易想到组件化的好处：</p>
<ul>
<li>不相互依赖</li>
<li>可以互相交互</li>
<li>高度解耦</li>
<li>自由拆卸组合</li>
<li>重复利用</li>
</ul>
<h2 id="二、组件化环境"><a href="#二、组件化环境" class="headerlink" title="二、组件化环境"></a>二、组件化环境</h2><p>各个模块组件都能单独打包，对于测试是很友好的。在正式上线的时候，所有模块都需要App 壳才能运行。</p>
<h3 id="2-1-Gradle"><a href="#2-1-Gradle" class="headerlink" title="2.1 Gradle"></a>2.1 Gradle</h3><p>gradle 的根在哪里？ 就是 <em>settings.gradle</em> 这个文件！然后，我们整个项目有个 gradle ，这个 project 就在项目根目录下 <em>build.gradle</em> 。 build 的步骤就是：</p>
<ol>
<li><p>settings.gradle</p>
</li>
<li><p>Project 级别的 build.gradle</p>
</li>
<li><p>壳工程的 build.gradle</p>
</li>
<li><p>library 中的 build.gradle</p>
</li>
</ol>
<p>app 和 各个 module 中都有 gradle 文件，里面可能会包含相同代码，比如 编译工具版本、最小支持版本。<strong>我们可以在project 下面新建 gradle ，比如命名为 derry.gradle，在里面写上 ext 扩展块</strong>，代码如下：</p>
<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">ext {</span><br><span class="line">    compileSdkVersion <span class="number">30</span></span><br><span class="line">    defaultConfit {</span><br><span class="line">        minSdkVersion <span class="number">16</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>不过此时还不能被系统所认识，只能知道这是 key-value 的形式，我们只能将其引入到<strong>project 所属的gradle 中</strong>才能实现，那么，在 Project 的 build.gradle 中可以写如下代码：</p>
<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">from:</span> <span class="string">'derry.gradle'</span></span><br></pre></td></tr></tbody></table></figure>

<p>所以，在各个模块中，可以使用这个公共的gradle 文件了：</p>
<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> ext = rootProject.ext</span><br><span class="line">android {</span><br><span class="line">    compileSdkVersion ext.compileSdkVersion</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里不去定义 def ext 也是可以的，但是为什么要这么做呢？这是为了性能考虑，因为这样定义一下就相当于局部变量了，能提高运行速度（老师说这个可以在面试时候去说的，说明真的玩过gradle）。</p>
<p>最后，放上App 壳和各个模块之间的配置，可以做到：</p>
<ul>
<li><p>正式环境和测试环境的部署</p>
</li>
<li><p>当测试环境时，各个模块可以单独运行和打包，正式环境的时候必须依赖App壳才能运行</p>
</li>
<li><p>所有的公共配置都放在app.gradle 中，各个模块按需获取其中的配置（可能某些模块对于某个配置不需要）</p>
</li>
</ul>
<p>配置代码如下：</p>
<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//公共的依赖 derry.gradle 文件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 扩展块</span></span><br><span class="line">ext {</span><br><span class="line">    <span class="comment">// 正式环境 和 测试环境</span></span><br><span class="line">    isRelease = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 正式环境 和 测试环境 服务器 URL 配置</span></span><br><span class="line">    url = [</span><br><span class="line">            <span class="string">"debug"</span>  : <span class="string">"https://192.188.22.99/debug"</span>,</span><br><span class="line">            <span class="string">"release"</span>: <span class="string">"https://192.188.22.99/release"</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 建立Map存储，  key 和 value  都是自定义的</span></span><br><span class="line">    androidID = [</span><br><span class="line">            <span class="attr">compileSdkVersion        :</span> <span class="number">30</span>,</span><br><span class="line">            <span class="attr">buildToolsVersion        :</span> <span class="string">"30.0.1"</span>,</span><br><span class="line"></span><br><span class="line">            <span class="attr">applicationId            :</span> <span class="string">"com.derry.derry"</span>,</span><br><span class="line">            <span class="attr">minSdkVersion            :</span> <span class="number">16</span>,</span><br><span class="line">            <span class="attr">targetSdkVersion         :</span> <span class="number">30</span>,</span><br><span class="line">            <span class="attr">versionCode              :</span> <span class="number">1</span>,</span><br><span class="line">            <span class="attr">versionName              :</span> <span class="string">"1.0"</span>,</span><br><span class="line"></span><br><span class="line">            <span class="symbol">testInstrumentationRunner:</span> <span class="string">"androidx.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 建立Map存储，  key 和 value  都是自定义的</span></span><br><span class="line">    appID = [</span><br><span class="line">            <span class="symbol">app:</span> <span class="string">"com.derry.modularproject"</span>,</span><br><span class="line">            <span class="symbol">login:</span> <span class="string">"com.derry.login"</span>,</span><br><span class="line">            <span class="symbol">register:</span> <span class="string">"com.derry.register"</span></span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 300 行  MAP  key  value</span></span><br><span class="line">    dependenciesID = [</span><br><span class="line">            <span class="string">"appcompat"</span>       : <span class="string">"androidx.appcompat:appcompat:1.2.0"</span>,</span><br><span class="line">            <span class="string">"constraintlayout"</span>: <span class="string">"androidx.constraintlayout:constraintlayout:2.0.1"</span>,</span><br><span class="line">            <span class="string">"material"</span>        : <span class="string">"com.google.android.material:material:1.1.0"</span>,</span><br><span class="line">    ]</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//project 根目录下的 build.gradle</span></span><br><span class="line"><span class="comment">// 根目录下的build.gradle 引入   公共的一份 引入过来</span></span><br><span class="line">apply <span class="attr">from :</span> <span class="string">'derry.gradle'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// Top-level build file where you can add configuration options common to all sub-projects/modules.</span></span><br><span class="line">buildscript {</span><br><span class="line">    repositories {</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    }</span><br><span class="line">    dependencies {</span><br><span class="line">        classpath <span class="string">"com.android.tools.build:gradle:4.0.1"</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// <span class="doctag">NOTE:</span> Do not place your application dependencies here; they belong</span></span><br><span class="line">        <span class="comment">// in the individual module build.gradle files</span></span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">allprojects {</span><br><span class="line">    repositories {</span><br><span class="line">        google()</span><br><span class="line">        jcenter()</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">task clean(<span class="attr">type:</span> Delete) {</span><br><span class="line">    delete rootProject.buildDir</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//某个library</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">'com.android.library'</span></span><br><span class="line"></span><br><span class="line">println <span class="string">"Derry ---&gt; lib Student hao 2"</span></span><br><span class="line"></span><br><span class="line">android {</span><br><span class="line">    compileSdkVersion androidID.compileSdkVersion</span><br><span class="line">    buildToolsVersion androidID.buildToolsVersion</span><br><span class="line"></span><br><span class="line">    defaultConfig {</span><br><span class="line">        minSdkVersion androidID.minSdkVersion</span><br><span class="line">        targetSdkVersion androidID.targetSdkVersion</span><br><span class="line">        versionCode androidID.versionCode</span><br><span class="line">        versionName androidID.versionName</span><br><span class="line"></span><br><span class="line">        testInstrumentationRunner <span class="string">"androidx.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    buildTypes {</span><br><span class="line">        release {</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android-optimize.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">dependencies {</span><br><span class="line">    implementation fileTree(<span class="attr">dir:</span> <span class="string">"libs"</span>, <span class="attr">include:</span> [<span class="string">"*.jar"</span>])</span><br><span class="line"></span><br><span class="line">    <span class="comment">/*implementation "androidx.appcompat:appcompat:1.2.0"</span></span><br><span class="line"><span class="comment">    implementation "androidx.constraintlayout:constraintlayout:2.0.1"</span></span><br><span class="line"><span class="comment">    implementation "com.google.android.material:material:1.1.0"</span></span><br><span class="line"><span class="comment">    implementation "androidx.vectordrawable:vectordrawable:1.1.0"</span></span><br><span class="line"><span class="comment">    implementation "androidx.navigation:navigation-fragment:2.2.2"</span></span><br><span class="line"><span class="comment">    implementation "androidx.navigation:navigation-ui:2.2.2"</span></span><br><span class="line"><span class="comment">    implementation "androidx.lifecycle:lifecycle-extensions:2.2.0"*/</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 一行搞定300行 循环搞定</span></span><br><span class="line">    dependenciesID.each {k,v -&gt; implementation v}</span><br><span class="line"></span><br><span class="line">    testImplementation <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    androidTestImplementation <span class="string">'androidx.test.ext:junit:1.1.2'</span></span><br><span class="line">    androidTestImplementation <span class="string">'androidx.test.espresso:espresso-core:3.3.0'</span></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<figure class="highlight groovy"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//login这个 module 的 build.gradle</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// apply plugin: 'com.android.application'</span></span><br><span class="line"><span class="keyword">if</span> (isRelease) { <span class="comment">// 如果是发布版本时，各个模块都不能独立运行</span></span><br><span class="line">    apply <span class="attr">plugin:</span> <span class="string">'com.android.library'</span> <span class="comment">// 正式环境  library不能独立运行</span></span><br><span class="line">} <span class="keyword">else</span> {</span><br><span class="line">    apply <span class="attr">plugin:</span> <span class="string">'com.android.application'</span> <span class="comment">// 测试环境 application独立运行</span></span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">android {</span><br><span class="line">    compileSdkVersion <span class="number">30</span></span><br><span class="line">    buildToolsVersion <span class="string">"30.0.1"</span></span><br><span class="line"></span><br><span class="line">    defaultConfig {</span><br><span class="line">        <span class="comment">// applicationId "" // 有appid 能够独立运行</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isRelease) {  <span class="comment">// 能够独立运行 必须要有appID</span></span><br><span class="line">            applicationId appID.login <span class="comment">// 组件化模式能独立运行才能有applicationId</span></span><br><span class="line">        }</span><br><span class="line"></span><br><span class="line">        minSdkVersion <span class="number">16</span></span><br><span class="line">        targetSdkVersion <span class="number">30</span></span><br><span class="line">        versionCode <span class="number">1</span></span><br><span class="line">        versionName <span class="string">"1.0"</span></span><br><span class="line"></span><br><span class="line">        testInstrumentationRunner <span class="string">"androidx.test.runner.AndroidJUnitRunner"</span></span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    buildTypes {</span><br><span class="line">        release {</span><br><span class="line">            minifyEnabled <span class="literal">false</span></span><br><span class="line">            proguardFiles getDefaultProguardFile(<span class="string">'proguard-android-optimize.txt'</span>), <span class="string">'proguard-rules.pro'</span></span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    sourceSets {</span><br><span class="line">        main {</span><br><span class="line">            <span class="keyword">if</span> (!isRelease) {</span><br><span class="line">                <span class="comment">// 如果是组件化模式，需要单独运行时 Debug</span></span><br><span class="line">                manifest.srcFile <span class="string">'src/main/debug/AndroidManifest.xml'</span> <span class="comment">// 生效</span></span><br><span class="line">            } <span class="keyword">else</span> { <span class="comment">// 正式环境下</span></span><br><span class="line">                <span class="comment">// 集成化模式，整个项目打包apk</span></span><br><span class="line">                manifest.srcFile <span class="string">'src/main/AndroidManifest.xml'</span> <span class="comment">// 让我们之前 默认的路径下的清单文件再次生效</span></span><br><span class="line"></span><br><span class="line">                java {</span><br><span class="line">                    <span class="comment">// 减小包大小，release 时 debug 目录下文件不需要合并到主工程</span></span><br><span class="line">                    exclude <span class="string">"**/debug/**"</span></span><br><span class="line">                }</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line">dependencies {</span><br><span class="line">    implementation fileTree(<span class="attr">dir:</span> <span class="string">"libs"</span>, <span class="attr">include:</span> [<span class="string">"*.jar"</span>])</span><br><span class="line">    implementation <span class="string">'androidx.appcompat:appcompat:1.2.0'</span></span><br><span class="line">    implementation <span class="string">'androidx.constraintlayout:constraintlayout:2.0.4'</span></span><br><span class="line">    testImplementation <span class="string">'junit:junit:4.12'</span></span><br><span class="line">    androidTestImplementation <span class="string">'androidx.test.ext:junit:1.1.2'</span></span><br><span class="line">    androidTestImplementation <span class="string">'androidx.test.espresso:espresso-core:3.3.0'</span></span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>上面代码可能有一些重复的，每个 gradle 文件可能侧重某一个点，需要注意甄别。</p>
<h2 id="三、组件之间的通信方式"><a href="#三、组件之间的通信方式" class="headerlink" title="三、组件之间的通信方式"></a>三、组件之间的通信方式</h2><p>如果订单模块想要访问个人模块的信息，那我们必须要有个什么注册表，我们将这些功能注册到这个注册表中，需要调用的时候，就通过这个注册表。</p>
<p>组件化几种可行的通信方式：</p>
<ul>
<li><p>EventBus：缺点是EventBean 的维护成本太高，不好管理</p>
</li>
<li><p>广播：不好管理，都统一发送出去了，并且后续Android版本广播都需要动态注册了（这点存疑，需要验证）</p>
</li>
<li><p>使用隐式意图：这个就更麻烦了，要求每个 Activity 都必须有自己<strong>唯一</strong>的action 名字</p>
</li>
<li><p>类加载方式：容易写错包名的类，相对而言缺点较少，可以尝试</p>
</li>
<li><p>使用全局 Map ：因为所有的 module 都需要依赖公共基础库，所以可以在公共基础库中添加一个 Map ，注册所有的Activity， 需要注册很多对象，相对而言缺点少，可以尝试</p>
</li>
</ul>
<p>其中类加载和 全局 Map 的方式使用代码如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">jumpPersonal</span><span class="params">(View view)</span> </span>{</span><br><span class="line">    <span class="comment">// todo 方式一 类加载</span></span><br><span class="line">    <span class="comment">// 类加载跳转，可以成功。维护成本较高且容易出现人为失误</span></span><br><span class="line">    <span class="keyword">try</span> {</span><br><span class="line">        Class targetClass = Class.forName(<span class="string">"com.xiangxue.personal.Personal_MainActivity"</span>);</span><br><span class="line">        Intent intent = <span class="keyword">new</span> Intent(<span class="keyword">this</span>, targetClass);</span><br><span class="line">        intent.putExtra(<span class="string">"name"</span>, <span class="string">"derry"</span>);</span><br><span class="line">        startActivity(intent);</span><br><span class="line">    } <span class="keyword">catch</span> (ClassNotFoundException e) {</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">// personal/Personal_MainActivity getMap</span></span><br><span class="line">    <span class="comment">// todo 方式二 全局Map</span></span><br><span class="line">    Class&lt;?&gt; targetActivity =</span><br><span class="line">            RecordPathManager.startTargetActivity(<span class="string">"personal"</span>, <span class="string">"Personal_MainActivity"</span>);</span><br><span class="line">    startActivity(<span class="keyword">new</span> Intent(<span class="keyword">this</span>, targetActivity));</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<blockquote>
<p>需要注意的一点是，使用类加载方式，我们使用的是 Class.forName 的方式，这个是反射吗？<strong>这并不是反射，这只是类加载！反射我们是指反射属性，方法等，我们也不会看到导入的包里面有 Reflect 等反射的包名</strong></p>
</blockquote>
<p>当然，使用全局 Map 的方式必须还要在 Common 公共依赖里面有管理类：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 全局路径记录器（根据子模块进行分组）</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * 组名：app，order，personal</span></span><br><span class="line"><span class="comment"> *       详情order=[Order_MainActivity,Order_MainActivity2,Order_MainActivity3]</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RecordPathManager</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 先理解成 仓库</span></span><br><span class="line"><span class="comment">     * group: app,order,personal</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * order:</span></span><br><span class="line"><span class="comment">     *      OrderMainActivity1</span></span><br><span class="line"><span class="comment">     *      OrderMainActivity2</span></span><br><span class="line"><span class="comment">     *      OrderMainActivity3</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> Map&lt;String, List&lt;PathBean&gt;&gt; maps = <span class="keyword">new</span> HashMap&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 将路径信息加入全局Map</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> groupName 组名，如："personal"</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pathName  路劲名，如："Personal_MainActivity"</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> clazz     类对象，如：Personal_MainActivity.class</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">addGroupInfo</span><span class="params">(String groupName, String pathName, Class&lt;?&gt; clazz)</span> </span>{</span><br><span class="line">        List&lt;PathBean&gt; list = maps.get(groupName);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (<span class="keyword">null</span> == list) {</span><br><span class="line">            list = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line">            list.add(<span class="keyword">new</span> PathBean(pathName, clazz));</span><br><span class="line">            <span class="comment">// 存入仓库</span></span><br><span class="line">            maps.put(groupName, list);</span><br><span class="line">        } <span class="keyword">else</span> {</span><br><span class="line">            <span class="comment">// 存入仓库</span></span><br><span class="line">            maps.put(groupName, list);</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 只需要告诉我，组名 ，路径名，  就能返回 "要跳转的Class"</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> groupName 组名 oder</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> pathName 路径名  OrderMainActivity1</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> 跳转目标的class类对象</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> Class&lt;?&gt; startTargetActivity(String groupName, String pathName) {</span><br><span class="line">        List&lt;PathBean&gt; list = maps.get(groupName);</span><br><span class="line">        <span class="keyword">if</span> (list == <span class="keyword">null</span>) {</span><br><span class="line">            Log.d(Config.TAG, <span class="string">"startTargetActivity 此组名得到的信息，并没有注册进来哦..."</span>);</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">        }</span><br><span class="line">        <span class="comment">// 遍历 寻找 去匹配 “PathBean”对象</span></span><br><span class="line">        <span class="keyword">for</span> (PathBean pathBean : list) {</span><br><span class="line">            <span class="keyword">if</span> (pathName.equalsIgnoreCase(pathBean.getPath())) {</span><br><span class="line">                <span class="keyword">return</span> pathBean.getClazz();</span><br><span class="line">            }</span><br><span class="line">        }</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>然后，我们可以在各个 Module 里面需要注册当前 Module 所拥有的全部 Activity （当然，这个并不优雅，开发者可能会忘记，可以采用注解或者其他的方式去做，这里只是简单实现）：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppApplication</span> <span class="keyword">extends</span> <span class="title">BaseApplication</span> </span>{</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onCreate</span><span class="params">()</span> </span>{</span><br><span class="line">        <span class="keyword">super</span>.onCreate();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 如果项目有100个Activity，这种加法会不会太那个？  缺点</span></span><br><span class="line">        RecordPathManager.addGroupInfo(<span class="string">"app"</span>, <span class="string">"MainActivity"</span>, MainActivity.class);</span><br><span class="line">        RecordPathManager.addGroupInfo(<span class="string">"order"</span>, <span class="string">"Order_MainActivity"</span>, Order_MainActivity.class);</span><br><span class="line">        RecordPathManager.addGroupInfo(<span class="string">"personal"</span>, <span class="string">"Personal_MainActivity"</span>, Personal_MainActivity.class);</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>所以，全局Map 的方案跳转的时候，只需要标明你想跳转哪个module ，以及module 中的哪个 Activity。但是上述方式还是有点麻烦，这时候，<strong>阿里开源的 Arouter就应运而生了</strong>。</p>
<p>组件化通信框架很多，但是目前最优秀的是 ARouter 。</p>
<p>组件化：模块之间没有依赖，便于重用</p>
<p>插件化：侧重动态化加载某些功能，主要问题是兼容性问题，支付宝都放弃了，因为你兼容了 5.0 ，能兼容 11.0 吗</p>
<p>模块化：模块化是业务层面的拆分，组件化是功能层次的划分</p>
<p>Google 表态说是 FrameWork 仍然还是 Java ，不会改成 Kotlin  </p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://glassx.github.io/2023/06/22/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/11-Retrofit%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="glassx">
      <meta itemprop="description" content="生活是天籁，需要凝神静听">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glassx的小黑屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/22/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/11-Retrofit%E8%AE%BE%E8%AE%A1%E6%A8%A1%E5%BC%8F/" class="post-title-link" itemprop="url">11-Retrofit设计模式</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-22 19:57:00" itemprop="dateCreated datePublished" datetime="2023-06-22T19:57:00+08:00">2023-06-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-28 23:02:47" itemprop="dateModified" datetime="2023-06-28T23:02:47+08:00">2023-06-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">听课笔记</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="一、策略模式"><a href="#一、策略模式" class="headerlink" title="一、策略模式"></a>一、策略模式</h2><p>都是基于同一个目的，采用不同的方式去实现。</p>
<p>比如： 想去西藏旅游，可以骑自行车、坐火车、坐飞机，这是不同的策略，最终都是去西藏旅游。</p>
<p>所以，Retrofit 中生成 call 采用 Adapter 的策略方式，这样就能适配各种情况，比如有人采用 RXJava ，这样就能设计自己Adapter ，返回的 call 不是 Okhttp 里面的 Call ，这样，避免太过于僵化。</p>
<h3 id="1-1-设计模式"><a href="#1-1-设计模式" class="headerlink" title="1.1 设计模式"></a>1.1 设计模式</h3><p>设计模式怎么学习：</p>
<ol>
<li><p>什么是设计模式</p>
</li>
<li><p>分析源码采用，为什么用，有什么好处</p>
</li>
<li><p>思考自己的项目，写对应的代码</p>
</li>
</ol>
<h2 id="二、动态代理"><a href="#二、动态代理" class="headerlink" title="二、动态代理"></a>二、动态代理</h2><p>为什么我使用 Retrofit 的时候，只需要定义一个 接口，然后就能直接使用这个接口了，接口也不能创建对象啊。其实就是动态代理的设计模式实现的。来看看他们这个的使用方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">GitHubService service = retrofit.create(GitHubService.class);</span><br></pre></td></tr></tbody></table></figure>

<p>使用动态代理，虚拟机就会自动生成一个类，实现了这个接口的一个类。</p>
<p>静态代理相当于经纪人，可以代理特定的人；动态代理相当于经济公司，动态生成代理人，能够适应各种各样的被代理人需求，拍电影的、唱歌的、跳舞的都能代理，因为是动态生成的。</p>
<h2 id="三、适配器设计模式"><a href="#三、适配器设计模式" class="headerlink" title="三、适配器设计模式"></a>三、适配器设计模式</h2><p>适配器的缺点：过多的适配器容易增加阅读的复杂度。</p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://glassx.github.io/2023/06/22/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/10-retrofit/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="glassx">
      <meta itemprop="description" content="生活是天籁，需要凝神静听">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glassx的小黑屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/22/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/10-retrofit/" class="post-title-link" itemprop="url">10-retrofit</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-22 10:49:00" itemprop="dateCreated datePublished" datetime="2023-06-22T10:49:00+08:00">2023-06-22</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-28 23:01:45" itemprop="dateModified" datetime="2023-06-28T23:01:45+08:00">2023-06-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">听课笔记</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><p>注意：Retrofit 的源码是基于 2.0.1 </p>
<h2 id="一、切面编程"><a href="#一、切面编程" class="headerlink" title="一、切面编程"></a>一、切面编程</h2><p>Okhttp 作为一个网络库是非常好的了，因为它采用了AOP切面思想（那些 Interceptors），也实现高内聚低耦合，但是在实际使用的时候有一些问题：</p>
<ul>
<li><p>用户网络请求的接口配置繁琐，尤其需要配置复杂请求body 、请求头 的时候</p>
</li>
<li><p>数据解析过程中需要用户手动拿到 responseBody 进行解析，（请求参数）不能复用</p>
</li>
<li><p>无法适配自动进行线程切换</p>
</li>
<li><p>存在嵌套的网络请求（如：UserId 获取到之后再获取用户详细信息，详细信息获取后再下单），就会陷入“回调地狱”</p>
</li>
</ul>
<p>基于此，Retrofit 就诞生了，它主要解决 2 个问题：</p>
<ul>
<li><p>请求前：统一配置网络的请求头，一致适配请求 request</p>
</li>
<li><p>请求后：数据适配（解析json数据）、线程切换</p>
</li>
</ul>
<p>Retrofit 总共 16个类，却采用了 8 种设计模式。</p>
<h2 id="二、Retrofit-类的本身设计思想"><a href="#二、Retrofit-类的本身设计思想" class="headerlink" title="二、Retrofit 类的本身设计思想"></a>二、Retrofit 类的本身设计思想</h2><h3 id="2-1-Retrofit-的整体使用"><a href="#2-1-Retrofit-的整体使用" class="headerlink" title="2.1 Retrofit 的整体使用"></a>2.1 Retrofit 的整体使用</h3><p>总体分为4个步骤：</p>
<ol>
<li><p>构建一个Retrofit</p>
</li>
<li><p>基于访问接口创建一个 接口类型的对象</p>
</li>
<li><p>基于接口类型的对象以及参数构建一个 Okhttp Call</p>
</li>
<li><p>将请求 Call 添加到 Okhttp 的请求队列</p>
</li>
</ol>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第一步</span></span><br><span class="line">Retrofit retrofit = <span class="keyword">new</span> Retrofit.Builder()</span><br><span class="line">        .baseUrl(<span class="string">"https://api.github.com/"</span>)</span><br><span class="line">        .build();</span><br><span class="line"></span><br><span class="line"><span class="comment">//第二步</span></span><br><span class="line">GitHubService service = retrofit.create(GitHubService.class);</span><br><span class="line"></span><br><span class="line"><span class="comment">//第三步</span></span><br><span class="line">Call&lt;List&lt;Repo&gt;&gt; repos = service.listRepos(<span class="string">"octocat"</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//第四步</span></span><br><span class="line">repos.enqueue(<span class="keyword">new</span>  Callable&lt;List&lt;Repo&gt;&gt;(){</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onResponse</span><span class="params">(XX xx, YY yy)</span> </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onFailure</span><span class="params">(M m ,N n)</span> </span>{</span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">});</span><br></pre></td></tr></tbody></table></figure>

<p>其中，接口 GitHubService.java 的代码可能是这样的 ：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">GitHubService</span> </span>{</span><br><span class="line">  <span class="meta">@GET("users/{user}/repos")</span></span><br><span class="line">  Call&lt;List&lt;Repo&gt;&gt; listRepos(<span class="meta">@Path("user")</span> String user);</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>  根据上面的代码，我们可以有几个疑问：</p>
<ul>
<li><p>看第二步，貌似我们的接口被直接使用了？根据我们学习的 Java 知识，接口不能被直接使用啊，没有接口实例啊</p>
</li>
<li><p>第三步传入的 参数 “octocat” 到底去哪里了</p>
</li>
<li><p>url 到底怎么形成的？因为我们传入的只有一个主域名 “<a target="_blank" rel="noopener" href="https://api.github.com/&quot;">https://api.github.com/"</a></p>
</li>
<li><p>为什么所有的请求都是同样的方式</p>
</li>
</ul>
<p>当你一行行看代码的时候就完蛋了，就会陷入细节，应该先看框架，看大体，思路流程好了之后再看细节。</p>
<p>参数大于 5 个 &amp;&amp; 带有可选参数，我们就可以使用构建者模式，这是使用 Builder 的一个原则。</p>
<h2 id="三、Retrofit-设计的-AOP-思想"><a href="#三、Retrofit-设计的-AOP-思想" class="headerlink" title="三、Retrofit 设计的 AOP 思想"></a>三、Retrofit 设计的 AOP 思想</h2><p>从代码：</p>
<blockquote>
<p>GitHubService service = retrofit.create(GitHubService.class); </p>
</blockquote>
<p>可以看出，retrofit 肯定创建了接口子类对象了， 不然不可能给接口变量赋值。在 Retrofit 类中这个 create 方法的实现如下：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">create</span><span class="params">(<span class="keyword">final</span> Class&lt;T&gt; service)</span> </span>{</span><br><span class="line">  validateServiceInterface(service);</span><br><span class="line">  <span class="keyword">return</span> (T)</span><br><span class="line">      Proxy.newProxyInstance(</span><br><span class="line">          service.getClassLoader(),</span><br><span class="line">          <span class="keyword">new</span> Class&lt;?&gt;[] {service},</span><br><span class="line">          <span class="keyword">new</span> InvocationHandler() {</span><br><span class="line">            <span class="keyword">private</span> <span class="keyword">final</span> Object[] emptyArgs = <span class="keyword">new</span> Object[<span class="number">0</span>];</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="meta">@Nullable</span> <span class="function">Object <span class="title">invoke</span><span class="params">(Object proxy, Method method, <span class="meta">@Nullable</span> Object[] args)</span></span></span><br><span class="line"><span class="function">                <span class="keyword">throws</span> Throwable </span>{</span><br><span class="line">              <span class="comment">// If the method is a method from Object then defer to normal invocation.</span></span><br><span class="line">              <span class="keyword">if</span> (method.getDeclaringClass() == Object.class) {</span><br><span class="line">                <span class="keyword">return</span> method.invoke(<span class="keyword">this</span>, args);</span><br><span class="line">              }</span><br><span class="line">              args = args != <span class="keyword">null</span> ? args : emptyArgs;</span><br><span class="line">              Platform platform = Platform.get();</span><br><span class="line">              <span class="keyword">return</span> platform.isDefaultMethod(method)</span><br><span class="line">                  ? platform.invokeDefaultMethod(method, service, proxy, args)</span><br><span class="line">                  : loadServiceMethod(method).invoke(args);</span><br><span class="line">            }</span><br><span class="line">          });</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>从上面可以看出来，这是动态代理实现的。它会生成一个 </p>
<h2 id="四、是否可以作为单例"><a href="#四、是否可以作为单例" class="headerlink" title="四、是否可以作为单例"></a>四、是否可以作为单例</h2><p>Retrofit 在使用的时候，能不能封装成单例呢？很多同学在 build 出来 Retrofit 对象后，将其作为单例保存，但其实不建议这么做。老师说的是可能带来内存泄漏，在 build 的时候，会有很多变量都会保存起来在 Retrofit 中，都会一直占内存。（对于这个论据不太认可，网络是会贯穿整个 App 使用周期的，所以网络的对象持续整个 App 生命周期感觉问题也不大）</p>
<blockquote>
<p>如果网络请求非常非常频繁，比如股票，那我们就可以考虑 netty 。普通 App 的请求使用完就可以销毁。</p>
</blockquote>
<h2 id="五、ServiceMethod-的存在价值"><a href="#五、ServiceMethod-的存在价值" class="headerlink" title="五、ServiceMethod 的存在价值"></a>五、ServiceMethod 的存在价值</h2><p>注解的使用：</p>
<ul>
<li><p>apt 技术：生成代码</p>
</li>
<li><p>注解 + 反射 运用</p>
</li>
</ul>
<p>ServiceMethod 主要作用就是解析注解，解析请求返回值</p>
<p>将接口转变为 Okhttp 的 Call ，把注解和传入的参数一起封装在里面。所以，一个请求接口对应一个 ServiceMethod ，当一个 interface 中有多个 方法时，就会对应多个 ServiceMethod 。</p>
<p>默认的话，获取到的 Call 是 ExecutorCallbackCall<t> 这个类型。第四步中的 enqueue 操作，最终会调用到 OkhttpCall 的 enqueue ，会里面会创建一个真正的 OkhttpCall 。 </t></p>
<p>ServiceMethod 中封装了所有的变量，所以 toRequest 方法可以利用这些变量（包括 post/get 等）封装出一个 OKhttp 的 Request 对象。</p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://glassx.github.io/2023/06/21/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/09-Glide-%E7%AC%AC%E4%B8%89%E8%8A%82%E8%AF%BE(%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AD%A6%E4%B9%A0)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="glassx">
      <meta itemprop="description" content="生活是天籁，需要凝神静听">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glassx的小黑屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/21/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/09-Glide-%E7%AC%AC%E4%B8%89%E8%8A%82%E8%AF%BE(%E7%BC%93%E5%AD%98%E6%9C%BA%E5%88%B6%E7%9A%84%E5%AD%A6%E4%B9%A0)/" class="post-title-link" itemprop="url">09-Glide-第三节课(缓存机制的学习)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-21 10:33:00" itemprop="dateCreated datePublished" datetime="2023-06-21T10:33:00+08:00">2023-06-21</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-28 23:00:16" itemprop="dateModified" datetime="2023-06-28T23:00:16+08:00">2023-06-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">听课笔记</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><p>缓存和生命周期是 Glide 的精华。</p>
<h2 id="一、资源封装"><a href="#一、资源封装" class="headerlink" title="一、资源封装"></a>一、资源封装</h2><p>Glide 总共有三级缓存，分别是：</p>
<ul>
<li><p>活动缓存</p>
</li>
<li><p>LRU 内存缓存</p>
</li>
<li><p>磁盘缓存</p>
</li>
</ul>
<p>整个资源的获取流程是比较复杂的，一张图来说就是这样：</p>
<p><img src="/assets/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/%E4%BA%AB%E5%AD%A6Android%E7%AC%AC%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/Glide%E7%BC%93%E5%AD%98%E5%8A%A0%E8%BD%BD%E8%BF%87%E7%A8%8B.jpg" alt="Glide缓存加载过程"></p>
<p>具体而言就是：</p>
<ol>
<li><p>加载图片的时候，<strong>首先从活动缓存中获取</strong>，如果没有，则去LRU 内存缓存中获取</p>
</li>
<li><p>如果LRU内存缓存中有的话，则将图片<strong>剪切</strong>（图片从内存缓存中<strong>移动</strong>到活动缓存中，LRU内存缓存自己就没有了）到活动缓存并且使用</p>
</li>
<li><p>如果 LRU 内存中没有的话，则会请求网络，请求成功后保存到磁盘缓存中，<strong>并且复制一份到活动缓存供马上使用</strong></p>
</li>
<li><p>当监听到生命周期执行 onDestroy （非 Application 生命周期情况下利用空白 Fragment 监听），则会将活动缓存中的图片<strong>移入LRU内存缓存中</strong></p>
</li>
</ol>
<blockquote>
<p>注意，LRU 内存缓存和 磁盘缓存都采用了 LRU 算法存储图片</p>
</blockquote>
<h2 id="资源封装"><a href="#资源封装" class="headerlink" title="资源封装"></a>资源封装</h2><p>Glide 的资源封装，是将图片 url 作为 key（需要处理下，比如是用sh256处理） ，Bitmap 作为 Value </p>
<h2 id="活动缓存（ActiveCache-java）"><a href="#活动缓存（ActiveCache-java）" class="headerlink" title="活动缓存（ActiveCache.java）"></a>活动缓存（ActiveCache.java）</h2><p>提到缓存，肯定就涉及到：容器、put 、get 这三个</p>
<p>活动缓存的容器就使用一个 普通的 HashMap 即可，因为只需要存储目前正在使用的图片，其中key 为 处理过的 url ，value 为封装的 Bitmap 即可。同时各个元素添加进来的时候实现接口 callback ，方便在生命周期变化的时候回收和移动封装的 Bitmap 。</p>
<h2 id="内存缓存-MemoryCache-java"><a href="#内存缓存-MemoryCache-java" class="headerlink" title="内存缓存(MemoryCache.java)"></a>内存缓存(MemoryCache.java)</h2><p>LRUCache 的实现中，sizeOf 默认是返回 1 ，意味着，默认情况下每个元素的大小是 1 不是实际的图片大小。所以在 MemoryCache.java （继承了 LRUCache 类）需要重写其 sizeOf 方法。</p>
<h3 id="Android-获取-Bitmap-的大小"><a href="#Android-获取-Bitmap-的大小" class="headerlink" title="Android 获取 Bitmap 的大小"></a>Android 获取 Bitmap 的大小</h3><p>在最开始的时候，使用 Bitmap.getRowBytes ，这个方法最终是在 native 层实现的。到了 API 12 也就是 3.0 的时候，开始更改方法，变成了  Bitmap.getByteCount() ，它是在 Java 层实现的。到了 API 19 也就是 4.4 的时候，又变成了 Bitmap.getAllocationByteCount 了，又放到 Native 层实现了。</p>
<blockquote>
<p>说一下，为什么我们设计的时候，需要将 url 进行处理后才能作为key ？这是因为我们磁盘存储文件的时候，命名不能包含斜杠和冒号等内容，会直接报错的的</p>
</blockquote>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://glassx.github.io/2023/06/20/%E4%B8%8D%E5%8F%91%E5%B8%83%E7%9A%84%E6%96%87%E4%BB%B6/%E9%87%8E%E8%AF%BE/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="glassx">
      <meta itemprop="description" content="生活是天籁，需要凝神静听">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glassx的小黑屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/20/%E4%B8%8D%E5%8F%91%E5%B8%83%E7%9A%84%E6%96%87%E4%BB%B6/%E9%87%8E%E8%AF%BE/" class="post-title-link" itemprop="url">未命名</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-20 10:48:28" itemprop="dateCreated datePublished" datetime="2023-06-20T10:48:28+08:00">2023-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-01 21:03:44" itemprop="dateModified" datetime="2023-06-01T21:03:44+08:00">2023-06-01</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><p>Matrix 在每个方法的开始和结束的时候，添加了 埋点，那么这是怎么实现的呢？字节码插桩技术，是在编译的时候将代码放进去的。</p>
<p>内部类访问外部类的私有属性的原理：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">OutClass</span> </span>{</span><br><span class="line">    <span class="keyword">int</span> i ;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">int</span> j;</span><br><span class="line"></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">InnerClass</span> </span>{</span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="title">InnerClass</span><span class="params">()</span></span>{</span><br><span class="line">            <span class="keyword">int</span> k = i + j;</span><br><span class="line">        }</span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>为什么内部类 InnerClass 能直接使用 OutClass 中的 i 和 j ，尤其 j 还是 private 的。这是因为编译后，外部类会生成有一个<strong>静态</strong>方法：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">int</span> access$<span class="number">000</span>(com.demo.OutClass clazz) {</span><br><span class="line">    <span class="keyword">return</span> clazz.j;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>所以，最后内部类是通过静态方法获取到 j 的值。传入了 OutClass 的对象。而 i 是怎么拿到的呢？其实是通过 getfield 指令。</p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://glassx.github.io/2023/06/20/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/Framework%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/%EF%BC%8809%EF%BC%892021.12.28-PKMS%E6%9D%83%E9%99%90%E7%94%B3%E8%AF%B7%E5%AE%9E%E6%88%98---derry%E8%80%81%E5%B8%88/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="glassx">
      <meta itemprop="description" content="生活是天籁，需要凝神静听">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glassx的小黑屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/20/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/Framework%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/%EF%BC%8809%EF%BC%892021.12.28-PKMS%E6%9D%83%E9%99%90%E7%94%B3%E8%AF%B7%E5%AE%9E%E6%88%98---derry%E8%80%81%E5%B8%88/" class="post-title-link" itemprop="url">（09）2021.12.28-PKMS权限申请实战---derry老师</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-20 10:48:28" itemprop="dateCreated datePublished" datetime="2023-06-20T10:48:28+08:00">2023-06-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-28 22:06:41" itemprop="dateModified" datetime="2023-06-28T22:06:41+08:00">2023-06-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">听课笔记</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><p>6.0 以后，Android 权限分为正常权限和危险权限，危险权限有以下几种：</p>
<ul>
<li>calendar</li>
<li>Camera</li>
<li>Location</li>
<li>Phone-拨打电话</li>
<li>SMS -短信相关</li>
<li>Storage -读取存储相关的权限</li>
</ul>
<p>权限是一组一组的，如果你申请了 读取 存储的权限，那么写存储的权限可以不用，因为它们是同一组的。</p>
<p>权限申请整体代码过程如下图所示：</p>
<p><img src="/assets/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/%E4%BA%AB%E5%AD%A6Android%E7%AC%AC%E4%B8%89%E6%9C%9FVip/06-FrameWork%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/%E6%9D%83%E9%99%90%E7%94%B3%E8%AF%B7%E4%BB%A3%E7%A0%81%E6%B5%81%E7%A8%8B.png" alt="权限申请代码流程"></p>
<p>在 Activity 的 requestPermissions 的方法里面，最终会调用 startActivityForResult 启动授权 Activity ，这也是为什么我们能收到 onRequestPermissionsResult 的原因：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">requestPermissions</span><span class="params">(<span class="meta">@NonNull</span> String[] permissions, <span class="keyword">int</span> requestCode)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (requestCode &lt; <span class="number">0</span>) {</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"requestCode should be &gt;= 0"</span>);</span><br><span class="line">    }</span><br><span class="line">    <span class="keyword">if</span> (mHasCurrentPermissionsRequest) {</span><br><span class="line">        Log.w(TAG, <span class="string">"Can request only one set of permissions at a time"</span>);</span><br><span class="line">        <span class="comment">// Dispatch the callback with empty arrays which means a cancellation.</span></span><br><span class="line">        onRequestPermissionsResult(requestCode, <span class="keyword">new</span> String[<span class="number">0</span>], <span class="keyword">new</span> <span class="keyword">int</span>[<span class="number">0</span>]);</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    }</span><br><span class="line">    Intent intent = getPackageManager().buildRequestPermissionsIntent(permissions);</span><br><span class="line">    startActivityForResult(REQUEST_PERMISSIONS_WHO_PREFIX, intent, requestCode, <span class="keyword">null</span>);</span><br><span class="line">    mHasCurrentPermissionsRequest = <span class="keyword">true</span>;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>这里面有个小的知识点，Intent 是通过 build 创建出来的，这里是启动隐式的 App：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Intent <span class="title">buildRequestPermissionsIntent</span><span class="params">(<span class="meta">@NonNull</span> String[] permissions)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span> (ArrayUtils.isEmpty(permissions)) {</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"permission cannot be null or empty"</span>);</span><br><span class="line">    }</span><br><span class="line">    Intent intent = <span class="keyword">new</span> Intent(ACTION_REQUEST_PERMISSIONS);</span><br><span class="line">    intent.putExtra(EXTRA_REQUEST_PERMISSIONS_NAMES, permissions);</span><br><span class="line">    intent.setPackage(getPermissionControllerPackageName());</span><br><span class="line">    <span class="keyword">return</span> intent;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>直接使用 new Intent(ACTION_REQUEST_PERMISSIONS) 的方式，这是通过隐式意图来激活某个 Activity ，根据常量 ACTION_REQUEST_PERMISSIONS 可以在源码找到（肯定是在 AndroidManifest.xml 中）这个 Activity 就是 GrantPermissionsActivity 。这种隐藏的 App （比如apk安装器）我们直接启动是启动不了的。 </p>
<p>用户点击确认授权，会通过进程间通信交给PermissionManagerService 去处理，当然，过程还需要 PKMS 去查询这个 App 。</p>
<p>当授权通过后，会通过 Settings.writeRuntimePermissionxxx 方法将这个记录保留到 xml （system/users/0/runtime-permissions.xml 文件）中永久保存，此后会一直存在，如果卸载 App ，就将这个记录删除掉。</p>
<h3 id="权限申请源码流程总结"><a href="#权限申请源码流程总结" class="headerlink" title="权限申请源码流程总结:"></a>权限申请源码流程总结:</h3><p>第一步：MainActivity 调用 requestPermissions 进行动态权限申请；<br>第二步：requestPermissions函数通过隐式意图，激活PackageInstaller的GrantPermissionsActivity界面，让用户选择是否授权；<br>第三步：经过PKMS把相关信息传递给PermissionManagerService处理；<br>第四步：PermissionManagerService处理结束后回调给—-&gt;PKMS中的onPermissionGranted方法把处理结果返回；<br>第五步：PKMS通知过程中权限变化，并调用writeRuntimePermissionsForUserLPr函数让PackageManager的settings记录下相关授权信息；</p>
<h2 id="手写无侵入式框架"><a href="#手写无侵入式框架" class="headerlink" title="手写无侵入式框架"></a>手写无侵入式框架</h2><p>为什么要写？我短短一个 Activity 代码，申请权限却要写很长很长的权限申请代码。</p>
<p>权限申请</p>
<p>权限被取消</p>
<p>权限被取消，还勾选不再提示</p>
<p>可以用到 AspectJ ，这个后台用到，可以控制注解方法的执行不执行，满足条件执行 A 方法，不满足不执行。这个框架很复杂，是 javac 的二次封装。</p>
<p>这个框架的设计图如下：</p>
<p><img src="/assets/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/%E4%BA%AB%E5%AD%A6Android%E7%AC%AC%E4%B8%89%E6%9C%9FVip/06-FrameWork%E5%B1%82%E6%BA%90%E7%A0%81%E8%A7%A3%E6%9E%90/%E6%97%A0%E4%BE%B5%E5%85%A5%E6%A1%86%E6%9E%B6%E8%AE%BE%E8%AE%A1%E5%9B%BE.png" alt="无侵入框架设计图"></p>
<blockquote>
<p>以后的框架，应该都需要是 ，无侵入式的（由框架劫持用户的行为） AspectJ 劫持函数的执行</p>
<p>AspectJ 为什么可以无侵入式的 监听+劫持 我们的任何注解<br>javac Test.java Test.class (JVM只认识class) （我们看不懂字节码，JVM看得懂）<br>AspectJ(Javac) Test.java 注入代码 Test.class (JVM只认识class) （我们看不懂字节码，JVM看得懂）</p>
<p>空白的Activity（申请权限 申请成功 申请失败 用户拒绝申请 回调给外界 告诉AspectJ）</p>
<p>任何一个框架，都有三种方式实现：<br>1.无侵入式的 由框架监听用户 劫持用户的行为，用户是没有能力调用框架的（依赖AspectJ）<br>2.APT 注解处理器 侵入式的框架，编译期 Dagger2 Room ARouter DataBinding<br>3.传统 xUtils 反射</p>
<p>无侵入式：用户没有能力调用我们的框架，它连看都看不到我们的框架，<br> 是由我们的框架，全局监听用户的行为，劫持用户，控制用户，执行用户</p>
<p>我们框架特点：<br> 我只需要使用三个注解就行了</p>
<p>用户没有能力调用框架的API</p>
<p>用户也不需要传递this</p>
<p>由我们的框架 来 监听用户的 注解的</p>
</blockquote>
<h3 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h3><p>动态申请权限的流程？</p>
<p>有 15 步，应用进程跨系统服务进程 PKMS 通过 PermissionManagerService 检查权限情况，回调回来给 PKMS ，并且通过 Settings 通过 io 操作将权限结果写入 xml 文件中永久保存，除非卸载，才删除这个记录</p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://glassx.github.io/2023/06/17/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/09-Glide-%E7%AC%AC%E4%BA%8C%E8%8A%82%E8%AF%BE(%E6%9C%80%E6%96%B0Glide4.11%20%E4%B8%BB%E7%BA%BF%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="glassx">
      <meta itemprop="description" content="生活是天籁，需要凝神静听">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glassx的小黑屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/17/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/09-Glide-%E7%AC%AC%E4%BA%8C%E8%8A%82%E8%AF%BE(%E6%9C%80%E6%96%B0Glide4.11%20%E4%B8%BB%E7%BA%BF%E6%B5%81%E7%A8%8B%E5%88%86%E6%9E%90)/" class="post-title-link" itemprop="url">09-Glide-第二节课(最新Glide4.11 主线流程分析)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-17 21:29:00" itemprop="dateCreated datePublished" datetime="2023-06-17T21:29:00+08:00">2023-06-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-28 22:59:10" itemprop="dateModified" datetime="2023-06-28T22:59:10+08:00">2023-06-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">听课笔记</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><p>看源码最重要的 第一步，只管主线，简单走通，不要管支线</p>
<p>面试题：项目中已经大量使用 Glide ，但加载图片还是偶尔会出现内存溢出问题，说明大概原因。</p>
<p>答：可能在 Glide.with 的时候，传入了 Application 的作用域，或者从子线程使用了 Glide 也会导致变为 Application 作用域。在这种作用域下，不会创建空白 Fragment 对绑定页面进行生命周期管理。就会造成内存回收不及时的问题。</p>
<p>into 方法的时候，RequestBuilder 中会根据 ImageView 的 ScaleType 来生成不同的 ScaleType 的对象:</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> ViewTarget&lt;ImageView, TranscodeType&gt; <span class="title">into</span><span class="params">(<span class="meta">@NonNull</span> ImageView view)</span> </span>{</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!requestOptions.isTransformationSet() &amp;&amp; requestOptions.isTransformationAllowed() &amp;&amp; view.getScaleType() != <span class="keyword">null</span>) {</span><br><span class="line"></span><br><span class="line">    <span class="keyword">switch</span> (view.getScaleType()) {</span><br><span class="line">      <span class="keyword">case</span> CENTER_CROP:</span><br><span class="line">        requestOptions = requestOptions.clone().optionalCenterCrop();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> CENTER_INSIDE:</span><br><span class="line">        requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> FIT_CENTER:</span><br><span class="line">      <span class="keyword">case</span> FIT_START:</span><br><span class="line">      <span class="keyword">case</span> FIT_END:</span><br><span class="line">        requestOptions = requestOptions.clone().optionalFitCenter();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> FIT_XY:</span><br><span class="line">        requestOptions = requestOptions.clone().optionalCenterInside();</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> CENTER:</span><br><span class="line">      <span class="keyword">case</span> MATRIX:</span><br><span class="line">      <span class="keyword">default</span>:</span><br><span class="line">        <span class="comment">// Do nothing.</span></span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> into(</span><br><span class="line">      glideContext.buildImageViewTarget(view, transcodeClass),</span><br><span class="line">      <span class="comment">/*targetListener=*/</span> <span class="keyword">null</span>,</span><br><span class="line">      requestOptions,</span><br><span class="line">      Executors.mainThreadExecutor());</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>总结一下，Glide 中最重要的 3 个分段 with、load、into 的三个作用：</p>
<ul>
<li><p>with：返回 RequestManager ，里面决定是哪种作用域</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> RequestManager <span class="title">get</span><span class="params">(FragemntActivity activity)</span> </span>{</span><br><span class="line">    <span class="keyword">if</span>(Util.isOnBackgroundThread()) {</span><br><span class="line">        <span class="comment">//子线程，Application </span></span><br><span class="line">    } <span class="keyword">else</span> {</span><br><span class="line">        <span class="comment">//Activity/Fragment 作用域</span></span><br><span class="line">    }</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>
</li>
<li><p>load：最终返回 RequestBuilder </p>
</li>
<li><p>into ： 最终返回 ImageViewTarget </p>
</li>
</ul>
<p>根据宽高、签名、等等一系列信息，作为某个图片缓存的 key ，在内存缓存和磁盘中获取这些缓存的图片。</p>
<h3 id="关于缓存"><a href="#关于缓存" class="headerlink" title="关于缓存"></a>关于缓存</h3><p>Glide 里面有活动缓存（ActiveResources）和内存缓存（Cache，也叫二级缓存，也叫LRU缓存），他们都在内存里面。那为什么要在内存里面设置 2 级缓存？<strong>Glide 将正在显示的图片都放在活动缓存里面</strong>（活动缓存里面都是使用 WeakReference 来引用图片），然后其他的图片都放在内存缓存里面。这又是什么讲究？内存缓存是 LRUCache 实现的，它可以存储很多图片，假如没有活动缓存这一级，而是直接使用内存缓存的话，那么在缓存的图片数量或者大小超限的时候，正在使用的图片就可能被清除掉，导致崩溃 Bug（比如RecyclerView里面使用，划过来可以，再划回去重新加载的时候被回收了就崩溃了） ，这也是为什么需要设计 2 级缓存。</p>
<blockquote>
<p>当应用需要获取图片的时候，首先从活动缓存中获取，如果没有，则去内存缓存中获取，如果命中了，则将 内存缓存中的图片添加到活动缓存中，并且将图片资源从内存缓存中删除。当引用的页面（Activity/Fragment）关掉之后，活动缓存的图片又可以放入内存缓存中去，如果页面再次打开，就又可能从内存缓存中加载进入活动缓存。活动缓存和内存缓存中只能存在一份缓存，不可能同时在 内存缓存和活动缓存中都存在。活动缓存里面会做引用计数，如果计数为 0 的时候，会将图片放回到内存缓存里面。</p>
</blockquote>
<p>面试官：Glide 源码中到处都是接口，我们应该怎么阅读？</p>
<p>答： 我们要找里面的伏笔。比如，我们 getRequest 的时候，要一直追踪下去，看看到底这个 getRequest 返回的是 Request 的哪个子类。不然很难知道具体是哪个类实现。</p>
<p>面试官：使用 Glide 为什么需要加入网络权限？</p>
<p>答： Glide 中执行图片请求的时候 <strong>有等待队列和运行队列</strong>2个队列，并且有 <strong>活动缓存和内存缓存</strong>2级缓存，如果这2级缓存都没有命中的话，需要通过网络去获取资源。并且，还可以通过 job.get 去判断目前任务是否完成，最终使用 UrlConnection 去完成最终的网络请求。</p>
<p>我们平时使用 Glide 一般都是传入 String 类型的 url ，然后会返回 InputStream 这种流，decode 的作用就是将流转成 Bitmap 。</p>
<p>面试官：使用 Glide 的时候，如果 with 函数在子线程调用，会有什么问题？</p>
<p>答：子线程不会去添加生命周期机制，主线程才会添加空白Fragment 监听 Activity/Fragment 的生命周期变化。</p>
<p>面试官：with 函数传入 Application ，会怎么样？</p>
<p>答：如果传入的是Activity 或者 Fragment ，当它们销毁的时候，Glide 会回收当前页面加载的图片任务和资源，但是如果传入的是 Application ，那么只有当应用结束的时候资源才会跟随销毁了。</p>
<p>如果ImageView 很小，但是图片是个很大的图片，Glide 会给做优化，只会给目标大小的图片就可以了。</p>
<p>最后，以一张Glide 的简化流程图结束：</p>
<p><img src="/assets/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/%E4%BA%AB%E5%AD%A6Android%E7%AC%AC%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/Glide%E6%95%B4%E4%BD%93%E7%AE%80%E5%8C%96%E5%9B%BE.png" alt="简化的Glide流程图"></p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

        
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block home" lang="zh-CN">
    <link itemprop="mainEntityOfPage" href="https://glassx.github.io/2023/06/17/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/09-Glide-%E7%AC%AC%E4%B8%80%E8%8A%82%E8%AF%BE(%E6%9C%80%E6%96%B0Glide4.11%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.jpeg">
      <meta itemprop="name" content="glassx">
      <meta itemprop="description" content="生活是天籁，需要凝神静听">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="glassx的小黑屋">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          
            <a href="/2023/06/17/%E4%BA%AB%E5%AD%A6%E8%AF%BE%E5%A0%82Android%E4%B8%89%E6%9C%9FVip/%E5%BC%80%E6%BA%90%E6%A1%86%E6%9E%B6/09-Glide-%E7%AC%AC%E4%B8%80%E8%8A%82%E8%AF%BE(%E6%9C%80%E6%96%B0Glide4.11%E6%BA%90%E7%A0%81%E9%98%85%E8%AF%BB)/" class="post-title-link" itemprop="url">09-Glide-第一节课(最新Glide4.11源码阅读)</a>
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>

              <time title="创建时间：2023-06-17 16:09:00" itemprop="dateCreated datePublished" datetime="2023-06-17T16:09:00+08:00">2023-06-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">更新于</span>
                <time title="修改时间：2023-06-28 22:55:08" itemprop="dateModified" datetime="2023-06-28T22:55:08+08:00">2023-06-28</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/%E5%90%AC%E8%AF%BE%E7%AC%94%E8%AE%B0/" itemprop="url" rel="index">
                    <span itemprop="name">听课笔记</span>
                  </a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <html><head></head><body></body></html><html><head></head><body><h2 id="一、为何监听Activity-Fragment-生命周期"><a href="#一、为何监听Activity-Fragment-生命周期" class="headerlink" title="一、为何监听Activity/Fragment 生命周期"></a>一、为何监听Activity/Fragment 生命周期</h2><p>Glide 的使用很简单：</p>
<figure class="highlight kotlin"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Glide.with(<span class="keyword">this</span>).load().into(imageView)</span><br></pre></td></tr></tbody></table></figure>

<p>其中的职责很简单：</p>
<ul>
<li><p>with ： 生命周期管理。传入 Activity 或者 Fragment 就会创建一个空白 Fragment 来监听生命周期，传入 Application Context 则不会</p>
</li>
<li><p>load：构建出 RequestBuilder 对象</p>
</li>
<li><p>into ： 做了几件事情：1）运行队列、等待队列 2）活动缓存 3）内存缓存 4）网络模型</p>
</li>
</ul>
<p>面试题：我们使用了 Glide.with(this).load().into 加载图片之后，在 Activity 的 onDestroy 中是不是要调用：<em>Glide.with(this).clear(imageView)</em> 来清理掉不用的 View 呢？</p>
<blockquote>
<p>很多同学可能会回复这是必须的，但是事实上这不是必需的，因为 Glide 内部会有监听机制，在 Activity 的onDestroy 中会自动 clear 掉。</p>
</blockquote>
<h2 id="二、生命周期作用域"><a href="#二、生命周期作用域" class="headerlink" title="二、生命周期作用域"></a>二、生命周期作用域</h2><p>那么 Glide 是怎么做到自动 clear 呢？原理在于<strong>它会创建一个空白的 Fragment 来监控 Activity/Fragment 的生命周期变化</strong>。</p>
<p>你可以发送很多的加载图片的request ，这些统一由 RequestManager 去管理。</p>
<p><strong>如果在子线程使用 Glide 加载图片，即时你传入 Activity ，也是在 Application 作用域，这时候不会给你搞那个空白的 Fragment</strong> 。总结一下各种情况下根据 with 传入的参数而产生的生命周期作用域：</p>
<ul>
<li><p><strong>在子线程</strong>：作用域为 Application</p>
</li>
<li><p>（在主线程）传入 ServiceContext/Application Context： 作用域为 Application</p>
</li>
<li><p>（在主线程）传入View：作用域为 Fragment 或者 Activity</p>
</li>
<li><p>（在主线程）传入 Fragment： 作用域为 Fragment</p>
</li>
<li><p>（在主线程）传入 Activity： 作用域为 Activity</p>
</li>
</ul>
<blockquote>
<p>所以也可以总结说 Application 作用域和非Application 作用域，这是根据是否创建空白 Fragment 监听生命周期这个动作来区分的</p>
</blockquote>
<p>老师说学习开源框架最好的方式就是：先大概看一遍，然后仿照它的 API 开始自己写，把它所有的实现都简化：比如它是工厂模式创建对象，那我就直接 new 出来；假如它有各种判空，直接干掉，假如有复杂的条件判断，先干掉。实现最简单的，这样才能快速理解整个流程。</p>
<p>RequestManager 中，生命周期 onStart 的时候: 运行队列-全部开始执行；等待队列-全部清空；onStop 的时候： 运行队列-全部停止，所有任务添加到等待队列；</p>
<p>Glide 中设计很巧妙的一个点就是：Glide 需要保证一个 Activity 只能有一个空白 Fragment 来监听它的生命周期，那么在 RequestManagerRetriever 这个类中，就会写出看起来匪夷所思的代码：</p>
<figure class="highlight java"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> RequestManagerFragment <span class="title">getRequestManagerFragment</span><span class="params">(FragmentManager fm, Fragment parentHint, <span class="keyword">boolean</span> isParentVisible)</span> </span>{</span><br><span class="line">  RequestManagerFragment current = (RequestManagerFragment) fm.findFragmentByTag(FRAGMENT_TAG);</span><br><span class="line">  <span class="keyword">if</span> (current == <span class="keyword">null</span>) {</span><br><span class="line">    current = pendingRequestManagerFragments.get(fm);</span><br><span class="line">    <span class="keyword">if</span> (current == <span class="keyword">null</span>) {</span><br><span class="line">      current = <span class="keyword">new</span> RequestManagerFragment();</span><br><span class="line">      current.setParentFragmentHint(parentHint);</span><br><span class="line">      <span class="keyword">if</span> (isParentVisible) {</span><br><span class="line">        current.getGlideLifecycle().onStart();</span><br><span class="line">      }</span><br><span class="line">      pendingRequestManagerFragments.put(fm, current);</span><br><span class="line">      fm.beginTransaction().add(current, FRAGMENT_TAG).commitAllowingStateLoss();</span><br><span class="line">      handler.obtainMessage(ID_REMOVE_FRAGMENT_MANAGER, fm).sendToTarget();</span><br><span class="line">    }</span><br><span class="line">  }</span><br><span class="line">  <span class="keyword">return</span> current;</span><br><span class="line">}</span><br></pre></td></tr></tbody></table></figure>

<p>创建了这个 fragment 需要将其放入map 中先保存起来，之后再 commit 这个 fragment ；再然后就通过 Handler 移除这个 fragment ，为什么这么做？</p>
<p>这是因为 fragment 做 commit 操作的时候，是通过主线程的 Handler 执行的，最后会体现在handler 往主线程发送了一个 Message，如果这个Message 还没执行，此时来了第二个请求，那么它通过 getTag 去获取这个 Fragment 是获取不到的，那么就会再创建一个，所以这里需要缓存下；那为什么在 commit 之后可以通过（主线程的） Handler 移除缓存的Fragment 呢？那么是因为 ，由于 commit 操作先执行，那么 commit 这个 Message 肯定在后续的移除 fragment 的这个 Message 之后，由于 Handler 是顺序执行这些 Message 的，所以执行移除操作的时候，commit 的那个 message 肯定已经执行过了，所以可以执行！</p>
<p>JetPack 的 Lifecycle 就是 模仿的 Glide 。Glide 的源码太庞大了。</p>
<p>有两个空白 Fragment ，一个是 Androidx 的 Fragment ，一个是 android.app 的 Fragment 。我们要注意区分。</p>
<h2 id="三、生命周期回调"><a href="#三、生命周期回调" class="headerlink" title="三、生命周期回调"></a>三、生命周期回调</h2><p>Fresco 看起来非常舒服，很容易看懂</p>
<p>但是 Glide 可能你看了一周源码，还是找不到网络请求的地方，看懂 Glide 的源码之后，再去看 Fresco 和 Picaso 都是很简单的事情。老师说是要研究半年才能给大家说这个事情。</p>
<p>老师说 RxJava 和 Okhttp 在 Glide 面前是小弟。这个也确实比较复杂</p>
</body></html>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

  </div>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/page/2/"><i class="fa fa-angle-left" aria-label="上一页"></i></a><a class="page-number" href="/">1</a><a class="page-number" href="/page/2/">2</a><span class="page-number current">3</span><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/23/">23</a><a class="extend next" rel="next" href="/page/4/"><i class="fa fa-angle-right" aria-label="下一页"></i></a>
  </nav>



          </div>
          

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目录
        </li>
        <li class="sidebar-nav-overview">
          站点概览
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="glassx"
      src="/images/avatar.jpeg">
  <p class="site-author-name" itemprop="name">glassx</p>
  <div class="site-description" itemprop="description">生活是天籁，需要凝神静听</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">223</span>
          <span class="site-state-item-name">日志</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">12</span>
        <span class="site-state-item-name">分类</span></a>
      </div>
      <div class="site-state-item site-state-tags">
            <a href="/tags/">
          
        <span class="site-state-item-count">39</span>
        <span class="site-state-item-name">标签</span></a>
      </div>
  </nav>
</div>
  <div class="feed-link motion-element">
    <a href="/atom.xml" rel="alternate">
      <i class="fa fa-rss"></i>RSS
    </a>
  </div>


  <div class="links-of-blogroll motion-element">
    <div class="links-of-blogroll-title">
      <i class="fa fa-fw fa-link"></i>
      Links
    </div>
    <ul class="links-of-blogroll-list">
        <li class="links-of-blogroll-item">
          <a href="https://atyxia.github.io/" title="https:&#x2F;&#x2F;atyxia.github.io&#x2F;" rel="noopener" target="_blank">传说中的伟哥</a>
        </li>
        <li class="links-of-blogroll-item">
          <a href="https://www.baidu.com/" title="https:&#x2F;&#x2F;www.baidu.com" rel="noopener" target="_blank">百度</a>
        </li>
    </ul>
  </div>

      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">glassx</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> 强力驱动 v5.4.0
  </div>
  <span class="post-meta-divider">|</span>
  <div class="theme-info">主题 – <a href="https://pisces.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Pisces</a> v7.5.0
  </div>


<script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
<div class="powered-by">
  <i class="fa fa-user-md"></i>
  <span id="busuanzi_container_site_pv">
    本站访问量:<span id="busuanzi_value_site_pv"></span>次
  </span>
  <span class="post-meta-divider">|</span>
  <span id="busuanzi_container_site_uv">
    本站总访客量：<span id="busuanzi_value_site_uv"></span>人
  </span>
</div>



<div class="theme-info">
  <div class="powered-by"></div>
  <span class="post-count">博客全站共444.1k字</span>
</div>



        
<div class="busuanzi-count">
  <script async src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
    <span class="post-meta-item" id="busuanzi_container_site_uv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-user"></i>
      </span>
      <span class="site-uv" title="总访客量">
        <span id="busuanzi_value_site_uv"></span>
      </span>
    </span>
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item" id="busuanzi_container_site_pv" style="display: none;">
      <span class="post-meta-item-icon">
        <i class="fa fa-eye"></i>
      </span>
      <span class="site-pv" title="总访问量">
        <span id="busuanzi_value_site_pv"></span>
      </span>
    </span>
</div>












        
      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>

<script src="/js/utils.js"></script>


<script src="/js/schemes/pisces.js"></script>


<script src="/js/next-boot.js"></script>




  




  
<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.css">
<script src="//cdn.jsdelivr.net/npm/instantsearch.js@2/dist/instantsearch.min.js"></script>
<script src="/js/algolia-search.js"></script>















  

  
  <script src="//cdn.jsdelivr.net/npm/quicklink@1/dist/quicklink.umd.js"></script>
  <script>
      window.addEventListener('load', () => {
      quicklink({
        timeout: 3000,
        priority: true,
        ignores: [uri => uri.includes('#'),uri => uri == 'https://glassx.github.io/page/3/',]
      });
      });
  </script>


</body>
</html>
